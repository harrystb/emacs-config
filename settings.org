#+TITLE: Emacs settings
#+AUTHOR: Harrison St Baker
#+EMAIL: harry.stbaker@gmail.com
* Package repo configuration
  Add the melpa repository and make sure use-package is installed
#+BEGIN_SRC emacs-lisp
(require 'package)
(add-to-list 'package-archives '("melpa" . "http://melpa.org/packages/") t)
(package-initialize)

(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))

(eval-when-compile
  (require 'use-package))
#+END_SRC

* Default Settings, which-key and basic key remaps
** Remove splash screen and echo area on startup
#+BEGIN_SRC emacs-lisp
(setq inhibit-startup-message t
      inhibit-startup-echo-area-message t)
#+END_SRC
** Enable which-key on pause
#+BEGIN_SRC emacs-lisp
  (which-key-mode 1)
  (setq which-key-side-window-location '(right, bottom))
#+END_SRC
** Remap basic keys
*** Evaluate commands
#+BEGIN_SRC emacs-lisp
  (setq hb-eval-map (make-sparse-keymap))
  (define-key hb-eval-map "r" '("Evaluate region" . eval-region))
  (define-key hb-eval-map "s" '("Evaluate Last Symbolic Expression" . eval-last-sexp))
#+END_SRC
*** Buffer commands
#+BEGIN_SRC emacs-lisp
  (setq hb-buffer-map (make-sparse-keymap))
  (define-key hb-buffer-map "b" '("Switch to buffer" . switch-to-buffer))
  (define-key hb-buffer-map "l" '("List buffers" . list-buffers))
#+END_SRC
*** Bookmark commands and custom functions
#+BEGIN_SRC emacs-lisp
  (defun hb-bookmark-this-file ()
    "Add this file or update location to the bookmarks list"
    (interactive)
    (bookmark-set (frame-parameter nil 'name) nil))
  (defun hb-unbookmark-this-file ()
    "Remove this file from the bookmarks list"
    (interactive)
    (bookmark-delete (frame-parameter nil 'name)))
  (defun hb-bookmarks-clear ()
    "Cleart the bookmarks list"
    (interactive)
    (bookmark-delete-all))
  (defun hb-bookmark-1 ()
    "Jump to bookmark 1 buffer or open if not already"
    (interactive)
    (let bm (nth 0 'bookmark-alist)))
  (setq hb-bookmark-map (make-sparse-keymap))
  (define-key hb-bookmark-map "a" '("Add to bookmarks" . hb-bookmark-this-file))
  (define-key hb-bookmark-map "d" '("Remove from bookmarks" . hb-unbookmark-this-file))
  (define-key hb-bookmark-map "c" '("Clear bookmarks" . hb-booksmarks-clear))
  (define-key hb-bookmark-map "m" '("List bookmarks" . list-bookmarks))
#+END_SRC


* Add on packages
** UI Changes
*** Colour theme Doom (dark)
#+BEGIN_SRC emacs-lisp
  (use-package doom-themes
    :ensure t
    :custom
    ;; Global settings (defaults)
    (doom-themes-enable-bold t)   ; if nil, bold is universally disabled
    (doom-themes-enable-italic t) ; if nil, italics is universally disabled
    ;; for treemacs users
    (doom-themes-treemacs-theme "doom-atom") ; use "doom-colors" for less minimal icon theme
    :config
    (load-theme 'doom-one t)

    ;; Enable flashing mode-line on errors
    (doom-themes-visual-bell-config)
    ;; Enable custom neotree theme (nerd-icons must be installed!)
    (doom-themes-neotree-config)
    ;; or for treemacs users
    (doom-themes-treemacs-config)
    ;; Corrects (and improves) org-mode's native fontification.
    (doom-themes-org-config))
#+END_SRC
*** Mode line
#+BEGIN_SRC emacs-lisp
  (use-package doom-modeline
    :ensure t
    :init (doom-modeline-mode 1))
#+END_SRC

** Key binding changes
*** Evil package (VIM Emulation)
#+BEGIN_SRC emacs-lisp
  (use-package evil
    :ensure t
    :config
    (evil-mode 1)
    (evil-set-leader 'normal (kbd "SPC"))
    (evil-set-leader 'visual (kbd "SPC"))
    (evil-define-key 'normal 'global (kbd "<leader>p") '("Projectile commands" . projectile-command-map))
    (evil-define-key 'normal 'global (kbd "<leader>b") (cons "Evaluate commands" hb-buffer-map))
    (evil-define-key 'normal 'global (kbd "<leader>e") (cons "Evaluate commands" hb-eval-map))
    (evil-define-key 'normal 'global (kbd "<leader>m") (cons "Bookmark commands" hb-bookmark-map))
    (evil-define-key 'normal 'global (kbd "<leader>ff") 'helm-find-files)
    (use-package evil-org
      :ensure t
      :config
      (evil-org-set-key-theme
       '(textobjects insert navigation additional shift todo heading))
      (add-hook 'org-mode-hook (lambda () (evil-org-mode))))
    )
#+END_SRC
** Navigation
*** Project navigation
#+BEGIN_SRC emacs-lisp
  (use-package helm
    :ensure t
    :config
      (helm-mode 1)
      (setq helm-ff-file-name-history-recentf t)
  )
  (use-package projectile
    :ensure t
    :after helm
    :config
    (projectile-mode +1)
    (setq projectile-project-search-path '("~/dev"))
    (setq-default projectile-completion-system 'helm)
    (projectile-register-project-type 'gitea '(".gitea")
                      :compile "RHOST=hts-nms1 gmake install")
    :bind
    (("<leader> p" . 'projectile-command-map)))
#+END_SRC
*** Treemacs package (folder display and navigation)
#+BEGIN_SRC emacs-lisp
  (use-package treemacs
    :ensure t
    :config
    (use-package treemacs-evil
      :ensure t)
    (use-package treemacs-magit
      :ensure t)
    (use-package treemacs-projectile
      :ensure t)
    :bind
    (:map global-map
	  ("M-0" . treemacs-select-window)
	  ("C-x t 1"   . treemacs-delete-other-windows)
	  ("C-x t t"   . treemacs)
	  ("C-x t B"   . treemacs-bookmark)
	  ("C-x t C-t" . treemacs-find-file)
	  ("C-x t M-t" . treemacs-find-tag)))
#+END_SRC

** Programming
*** LSP (Built in eglot)
#+BEGIN_SRC emacs-lisp
  (use-package eglot
    :bind
    (:map global-map
	("<leader><leader>a" . eglot-code-actions)
	("<leader><leader>r" . eglot-rename)
	))
#+END_SRC
*** Annotations
#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :ensure t
    :bind
    (:map global-map
	("<leader><leader>l" . flycheck-list-errors)
		  ))
#+END_SRC
*** Rust
#+BEGIN_SRC emacs-lisp
  (use-package rust-mode
    :ensure
    :config
    (add-hook 'rust-mode-hook (lambda () (setq indent-tabs-mode nil)))
    (add-hook 'rust-mode-hook 'electric-pair-mode)
    (add-hook 'rust-mode-hook 'flycheck-mode)
    (add-hook 'rust-mode-hook 'eglot-ensure)
    (setq rust-format-on-save t)
    (use-package flycheck
      :ensure t
      :config
      (add-hook 'rust-mode-hook 'flycheck-mode)
      (add-hook 'rust-mode-hook 'eglot-ensure))
    :bind
    (:map rust-mode-map
	  ("<leader> <leader> C-r" . rust-run)
	  )
    )

#+END_SRC
*** Flutter/Dart Packages
#+BEGIN_SRC emacs-lisp
  (use-package dart-mode
    :ensure t
    :hook
    (dart-mode . flutter-test-mode)
    (dart-mode . eglot-ensure)
    (dart-mode . electric-pair-mode))
  (use-package flutter
    :ensure t
    :after dart-mode
    :config 
    (defun my-flutter-run-or-hot-reload ()
      "Start `flutter run` or hot-reload if already running."
      (interactive)
      (if (flutter--running-p)
  	(flutter-hot-reload)
        (flutter-run "-d windows")))
    (defun my-flutter-before-save ()
      (lsp-format-buffer))
    (defun my-flutter-on-save-hot-reload ()
      "Start `flutter run` or hot-reload if already running."
      (lsp-format-buffer)
      (if (flutter--running-p)
  	(flutter-hot-reload)
        nil))
    (add-hook 'flutter-test-mode-hook (lambda () (add-hook 'after-save-hook 'my-flutter-on-save-hot-reload nil 'make-it-local)))
    (add-hook 'flutter-test-mode-hook (lambda () (add-hook 'before-save-hook 'my-flutter-before-save nil 'make-it-local)))
    :bind (:map dart-mode-map
  	      ("C-M-x" . #'my-flutter-run-or-hot-reload)))
  (use-package yaml-mode :ensure t)
#+END_SRC
** Auto completion and snippets (Company/Yasnippet)
*** Extra functions to be linked source: [[https://robert.kra.hn/posts/2021-02-07_rust-with-emacs/#:~:text=%20Configuring%20Emacs%20for%20Rust%20development%20%201,order%20to%20setup%20debugging%20support%20for...%20More%20]]
#+BEGIN_SRC emacs-lisp
(defun company-yasnippet-or-completion ()
  (interactive)
  (or (do-yas-expand)
      (company-complete-common)))

(defun check-expansion ()
  (save-excursion
    (if (looking-at "\\_>") t
      (backward-char 1)
      (if (looking-at "\\.") t
        (backward-char 1)
        (if (looking-at "::") t nil)))))

(defun do-yas-expand ()
  (let ((yas/fallback-behavior 'return-nil))
    (yas/expand)))

(defun tab-indent-or-complete ()
  (interactive)
  (if (minibufferp)
      (minibuffer-complete)
    (if (or (not yas/minor-mode)
            (null (do-yas-expand)))
        (if (check-expansion)
            (company-complete-common)
          (indent-for-tab-command)))))
#+END_SRC
*** Company (Completions)
#+BEGIN_SRC emacs-lisp
(use-package company
    :ensure
    :custom
	(company-idle-delay 0.5) ;; how long to wait until popup
	;; (company-begin-commands nil) ;; uncomment to disable popup
    :bind
	(:map company-active-map
		("C-n". company-select-next)
		("C-p". company-select-previous)
		("M-<". company-select-first)
		("M->". company-select-last))
	(:map company-mode-map
		("<tab>". tab-indent-or-complete)
		("TAB". tab-indent-or-complete))
    :config
    (add-hook 'rust-mode-hook 'company-mode))
#+END_SRC
*** Yasnippet (Snippets)
#+BEGIN_SRC emacs-lisp
(use-package yasnippet
  :ensure t
  :config
  (use-package yasnippet-snippets
    :ensure t)
  (define-key yas-minor-mode-map (kbd "<tab>") nil)
  (define-key yas-minor-mode-map (kbd "C-'") #'yas-expand)
  (add-to-list #'yas-snippet-dirs "~/.emacs.d/snippets")
  (yas-reload-all)
  (add-hook 'prog-mode-hook 'yas-minor-mode)
  (add-hook 'text-mode-hook 'yas-minor-mode)
  (setq yas-prompt-functions '(yas-ido-prompt))
  (defun help/yas-after-exit-snippet-hook-fn ()
    (prettify-symbols-mode)
    (prettify-symbols-mode))
  (add-hook 'yas-after-exit-snippet-hook #'help/yas-after-exit-snippet-hook-fn)
  :diminish yas-minor-mode)
(add-hook 'find-file-hook 'auto-insert)
(use-package yatemplate
  :ensure t
  :config
  (setq templates-private-directory "~/.emacs.d/templates"))
#+END_SRC


** Extra functionality
*** ISpell package (spell checking)
#+BEGIN_SRC emacs-lisp
(use-package ispell
  :ensure t
  :bind
  (("<leader>sw" . 'ispell-word)
   ("<leader>sr" . 'ispell-region)))
#+END_SRC
*** Magit (git in emacs)
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :ensure t
    :bind
    (("<leader> g" . 'magit))
  )
#+END_SRC
*** Mermaid JS Documentation extras (org mode)
#+BEGIN_SRC emacs-lisp
(use-package mermaid-mode
  :ensure t)
#+END_SRC
** Custom Functions
*** Increment or Decrement number at point
#+BEGIN_SRC emacs-lisp
(defun my-increment-number-decimal (&optional arg)
  "Increment the number forward from point by 'arg'."
  (interactive "p*")
  (save-excursion
    (save-match-data
      (let (inc-by field-width answer)
        (setq inc-by (if arg arg 1))
        (skip-chars-backward "0123456789")
        (when (re-search-forward "[0-9]+" nil t)
          (setq field-width (- (match-end 0) (match-beginning 0)))
          (setq answer (+ (string-to-number (match-string 0) 10) inc-by))
          (when (< answer 0)
            (setq answer (+ (expt 10 field-width) answer)))
          (replace-match (format (concat "%0" (int-to-string field-width) "d")
                                 answer)))))))
(defun my-decrement-number-decimal (&optional arg)
  (interactive "p*")
  (my-increment-number-decimal (if arg (- arg) -1)))
(global-set-key (kbd "C-<kp-add>") 'my-increment-number-decimal)
(global-set-key (kbd "C-<kp-subtract>") 'my-decrement-number-decimal)
(define-key function-key-map (kbd "<f13>") 'event-apply-super-modifier)
#+END_SRC
