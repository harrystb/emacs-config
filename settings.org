#+TITLE: Emacs settings
#+AUTHOR: Harrison St Baker
#+EMAIL: harry.stbaker@gmail.com
* Package repo configuration
  Add the melpa repository and make sure use-package is installed
#+BEGIN_SRC emacs-lisp
(require 'package)
(add-to-list 'package-archives '("melpa" . "http://melpa.org/packages/") t)
(package-initialize)

(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))

(eval-when-compile
  (require 'use-package))
#+END_SRC

* Default Settings, which-key and basic key remaps
** Remove splash screen, menu bar, scroll-bar, toolbar and echo area on startup
#+BEGIN_SRC emacs-lisp
  (setq inhibit-startup-message t
        inhibit-startup-echo-area-message t)
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (when (display-graphic-p)
    (scroll-bar-mode -1)
    )
#+END_SRC
** Setup line numbers
#+BEGIN_SRC emacs-lisp
  (setq display-line-numbers-type 'relative)
  (global-display-line-numbers-mode +1)
#+END_SRC
** Setup font
#+BEGIN_SRC emacs-lisp
  (when (and (window-system) (x-list-fonts "JetBrainsMono NF"))
    (set-frame-font "JetBrainsMono NF"))
#+END_SRC
** Enable which-key on pause
#+BEGIN_SRC emacs-lisp
  (which-key-mode 1)
  (setq which-key-side-window-location '(right, bottom))
#+END_SRC
** Map/Remap keys
*** Basic changes
#+BEGIN_SRC emacs-lisp
  ; Make escape cancel all menus
  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)
#+END_SRC
*** Evaluate commands
#+BEGIN_SRC emacs-lisp
  (setq hb-eval-map (make-sparse-keymap))
  (define-key hb-eval-map "r" '("Evaluate region" . eval-region))
  (define-key hb-eval-map "s" '("Evaluate Last Symbolic Expression" . eval-last-sexp))
  (define-key hb-eval-map "x" '("Execute Command" . execute-extended-command))
  (setq help-char "")
#+END_SRC
*** File commands
#+BEGIN_SRC emacs-lisp
  (setq hb-file-map (make-sparse-keymap))
  (define-key hb-file-map "f" '("Find file" . helm-find-files))
  (define-key hb-file-map "d" '("Open dired in folder of this file" . dired))
  (define-key hb-file-map "c" '("Open emacs config file" . (lambda () (interactive) (find-file (concat user-emacs-directory "settings.org")))))
#+END_SRC
*** Buffer commands
#+BEGIN_SRC emacs-lisp
  (setq hb-buffer-map (make-sparse-keymap))
  (define-key hb-buffer-map "b" '("Switch to buffer" . switch-to-buffer))
  (define-key hb-buffer-map "l" '("List buffers" . list-buffers))
#+END_SRC
*** Org commands
#+BEGIN_SRC emacs-lisp
  (setq hb-org-map (make-sparse-keymap))
  (define-key hb-org-map "p" '("Format paragraph" . org-fill-paragraph))
  (define-key hb-org-map "a" '("Agenda" . org-agenda))
  (define-key hb-org-map "t" '("Insert Timestamp" . org-timestamp))
#+END_SRC
*** Custom Harpoon functionality
#+BEGIN_SRC emacs-lisp
  (defvar hb-harpoon-list () "The list of buffers in the harpoon quick list")
  (defun hb-harpoon-add ()
    "Add this file to the harpoon list"
    (interactive)
    (let ((filename ""))
      (setq filename buffer-file-name)
      (if filename
  	(progn 
  	  (if hb-harpoon-list
  	      (unless (member filename hb-harpoon-list)
  		(setq hb-harpoon-list (append hb-harpoon-list (list filename)))
  		(message "File added")
  		)
  	    (setq hb-harpoon-list (list filename))
  	    (message "File added")
  	    )
  	  (hb-harpoon-save-to-disk))
        (message "Buffer is not a file")
        )))
  (defun hb-harpoon-remove ()
    "Add this file to the harpoon list"
    (interactive)
    (let ((filename ""))
      (setq filename buffer-file-name)
      (when (member filename hb-harpoon-list)
        (setq hb-harpoon-list (delete filename hb-harpoon-list))
        (message "File removed"))
      ))
  (defun hb-harpoon-clear ()
    (interactive)
    (setq hb-harpoon-list ()))
  (defun hb-harpoon-switch (n)
    "Quick switch to harpoon buffer n"
    (let (
          (file (nth n hb-harpoon-list)))
      (if file (find-file file) (message "Harpoon item %d not set" n))
      ))
  (defun hb-harpoon-list ()
    "Show *Harpoon Buffers* buffer"
    (interactive)
    ;; Create or update harpoon buffer
    (let ((buf (get-buffer-create "*Harpoon*")))
      (switch-to-buffer buf)
      (hb-harpoon-list-mode 1)
      (insert ";; Harpoon Quick Switch List:\n")
      (insert ";; Edit the buffer to rearrange the order if desired.\n")
      (insert ";; <q> save and quit    <enter> switch to buffer\n")
      (insert ";;  __________________________________________________\n\n")
      (save-excursion 
  	(dolist (file hb-harpoon-list)
  	  (insert (concat file "\n"))))))

  (defun hb-harpoon-load-from-buffer()
    (save-excursion
      (goto-char (point-min))
      (setq hb-harpoon-list ())
      (while (not (eobp))
        (let ((filename (string-trim (thing-at-point 'line t))))
  	(unless (or (not filename) (< (length filename) 2) (equal (substring filename 0 2) ";;"))
  	  (if hb-harpoon-list
  	      (unless (member filename hb-harpoon-list)
  		(setq hb-harpoon-list (append hb-harpoon-list (list filename)))
  		)
  	    (setq hb-harpoon-list (list filename))
  	    )))
        (forward-line 1)
        )
      ))
  (defvar hb-harpoon-data-file (concat user-emacs-directory "harpoon") "File that harpoon syncs with")
  (defun hb-harpoon-load-from-disk()
    (interactive)
    (let ((buf (find-file-noselect hb-harpoon-data-file)))
      (with-current-buffer buf
        (hb-harpoon-load-from-buffer))
      (kill-buffer buf)))
  (defun hb-harpoon-save-to-disk()
    (with-temp-buffer 
      (dolist (file hb-harpoon-list)
        (insert (concat file "\n")) 
        )
      (write-region (point-min) (point-max) hb-harpoon-data-file nil 0)))
  (defun hb-harpoon-list-kill ()
    (interactive)
    (let ((buf (get-buffer-create "*Harpoon*")))
      (with-current-buffer buf
      (hb-harpoon-load-from-buffer)
      (hb-harpoon-save-to-disk))
      (kill-buffer buf)))
  (defun hb-harpoon-list-switch ()
    (interactive)
    (let ((line (string-trim (thing-at-point 'line t))))
      (unless (or (< (length line) 2) (equal (substring line 0 2) ";;"))
        (find-file line)
        (hb-harpoon-list-kill)
        )
      ))
  (hb-harpoon-load-from-disk)
  ;; Setup minor mode
  (defvar hb-harpoon-list-map (make-sparse-keymap) "Keymap for harpoon list mode")
  (define-key hb-harpoon-list-map "q" '("Save and close Harpoon list buffer" . hb-harpoon-list-kill))
  (keymap-set hb-harpoon-list-map "<remap> <evil-record-macro>" 'hb-harpoon-list-kill)
  (define-key hb-harpoon-list-map "<return>" '("Switch to buffer" . hb-harpoon-list-switch))
  (keymap-set hb-harpoon-list-map "<remap> <evil-ret>" 'hb-harpoon-list-switch)
  (define-minor-mode hb-harpoon-list-mode
    "Toggles the harpoon list mode."
    :init-value nil
    :global nil
    :lighter " harpoon"
    :keymap hb-harpoon-list-map
    (if hb-harpoon-list-mode
        (message "Harpoon on")
      (message "Harpoon off")))

  (setq hb-harpoon-map (make-sparse-keymap))
  (define-key hb-harpoon-map "a" '("Add file to harpoon" . hb-harpoon-add))
  (define-key hb-harpoon-map "d" '("Remove file from harpoon" . hb-harpoon-remove))
  (define-key hb-harpoon-map "c" '("Clear harpoon files" . hb-harpoon-clear))
  (define-key hb-harpoon-map "m" '("List harpoon files" . hb-harpoon-list))
  (define-key global-map (kbd "C-h") '("Quickswitch to buffer 1" . (lambda () (interactive) (hb-harpoon-switch 0))))
  (define-key global-map (kbd "C-j") '("Quickswitch to buffer 2" . (lambda () (interactive) (hb-harpoon-switch 1))))
  (define-key global-map (kbd "C-k") '("Quickswitch to buffer 3" . (lambda () (interactive) (hb-harpoon-switch 2))))
  (define-key global-map (kbd "C-l") '("Quickswitch to buffer 4" . (lambda () (interactive) (hb-harpoon-switch 3))))
#+END_SRC
**** Unbind competing keybinds from other modes
#+BEGIN_SRC emacs-lisp
  (define-key org-mode-map (kbd "C-j") nil)
#+END_SRC
** Org mode settings
#+BEGIN_SRC emacs-lisp
  (setq org-cycle-emulate-tab 'white)
  (setq org-agenda-files (list "~/org/" user-emacs-directory))
#+END_SRC
** TODO Custom compile command loader
Create some functions to load in a commands file which then creates a
auto-completable list that can be run.  This could be a very basic
file format where each line is a pair of command name and the command
to run
#+BEGIN_SRC 
run-tmpltst -> cargo run --bin tmpltst
build-tmpltst -> cargo build --bin tmpltst
watch-tmptst -> cargo watch -x "run --bin tmpltst"
#+END_SRC
* Add on packages
** UI Changes
*** Colour theme Doom (dark)
#+BEGIN_SRC emacs-lisp
  (use-package doom-themes
    :ensure t
    :custom
    ;; Global settings (defaults)
    (doom-themes-enable-bold t)   ; if nil, bold is universally disabled
    (doom-themes-enable-italic t) ; if nil, italics is universally disabled
    :config
    (load-theme 'doom-challenger-deep t)
    ;; Enable flashing mode-line on errors
    (doom-themes-visual-bell-config)
    ;; Enable custom neotree theme (nerd-icons must be installed!)
    (doom-themes-neotree-config)
    ;; Corrects (and improves) org-mode's native fontification.
    (doom-themes-org-config))
#+END_SRC
*** Mode line
#+BEGIN_SRC emacs-lisp
  (use-package doom-modeline
    :ensure t
    :init (doom-modeline-mode 1))
#+END_SRC
*** Org mode look improvements
#+BEGIN_SRC emacs-lisp
  (use-package org-modern
    :ensure t
    :config
    (add-hook 'org-mode-hook #'org-modern-mode)
    (setq org-modern-star 'replace)
    (unless (display-graphic-p)
      (setq org-modern-table nil)
      ))
#+END_SRC
** Key binding changes
*** Enable kitty protocol (pass through super on terminal)
#+BEGIN_SRC emacs-lisp
(use-package kkp
  :config
  (global-kkp-mode 1))
#+END_SRC
*** Evil package (VIM Emulation)
#+BEGIN_SRC emacs-lisp
  (use-package evil
    :ensure t
    :config
    (evil-mode 1)
    (evil-set-leader '(normal visual motion) (kbd "SPC"))
    (evil-define-key '(normal visual motion) 'global (kbd "<leader>h") (cons "Help Commands" help-map))
    (evil-define-key '(normal visual motion) 'global (kbd "<leader>p") '("Projectile commands" . projectile-command-map))
    (evil-define-key '(normal visual motion) 'global (kbd "<leader>b") (cons "Buffer commands" hb-buffer-map))
    (evil-define-key '(normal visual motion) 'global (kbd "<leader>f") (cons "File commands" hb-file-map))
    (evil-define-key '(normal visual motion) 'global (kbd "<leader>e") (cons "Evaluate commands" hb-eval-map))
    (evil-define-key '(normal visual motion) 'global (kbd "<leader>m") (cons "Harpoon commands" hb-harpoon-map))
    (evil-define-key '(normal visual motion) 'global (kbd "<leader>o") (cons "Org commands" hb-org-map))
    (evil-define-key 'visual 'global (kbd "(") (lambda () (interactive) (insert-pair ?\( ?\)))
      (kbd "{") (lambda () (interactive) (insert-pair ?\{ ?\}))
      (kbd "[") (lambda () (interactive) (insert-pair ?\[ ?\]))
      (kbd "<") (lambda () (interactive) (insert-pair ?\< ?\>))
      (kbd "\"") (lambda () (interactive) (insert-pair ?\" ?\")))
    (evil-define-key 'normal org-mode-map (kbd "TAB") #'org-cycle)
    (use-package evil-org
      :ensure t
      :after org
      :hook (org-mode . (lambda () evil-org-mode))
      :config
      (require 'evil-org-agenda)
      (evil-org-agenda-set-keys)
      ))
#+END_SRC
** Navigation
*** Project navigation
#+BEGIN_SRC emacs-lisp
  (use-package helm
    :ensure t
    :config
      (helm-mode 1)
      (setq helm-ff-file-name-history-recentf t)
  )
  (use-package projectile
    :ensure t
    :after helm
    :config
    (projectile-mode +1)
    (setq projectile-project-search-path '("~/dev"))
    (setq-default projectile-completion-system 'helm)
    (projectile-register-project-type 'gitea '(".gitea")
                      :compile "RHOST=hts-nms1 gmake install")
    :bind
    (("<leader> p" . 'projectile-command-map)))
#+END_SRC
*** #DISABLED Treemacs package (folder display and navigation)
If re-enabling, check out an alternative is Neotree.
#+BEGIN_SRC emacs-lisp :tangle no
  (use-package treemacs
    :ensure t
    :config
    (use-package treemacs-evil
      :ensure t)
    (use-package treemacs-magit
      :ensure t)
    (use-package treemacs-projectile
      :ensure t)
    :bind
    (:map global-map
	  ("M-0" . treemacs-select-window)
	  ("C-x t 1"   . treemacs-delete-other-windows)
	  ("C-x t t"   . treemacs)
	  ("C-x t B"   . treemacs-bookmark)
	  ("C-x t C-t" . treemacs-find-file)
	  ("C-x t M-t" . treemacs-find-tag)))
#+END_SRC

** Programming
*** Treesitter (precompiled)
Pre-compiled tree-sitter languages can be downloaded using the
"tree-sitter-langs-install-grammars" function. They get stored
somewhere along the lines of
"/.emacs.d/elpa/tree-sitter-langs-20251102.1741/bin/".

The files that are wanted can be copied from that location and placed
in the "/.emacs.d/tree-sitter" folder with the name prefixed with
"libtree-sitter-"
#+BEGIN_SRC emacs-lisp
  (use-package tree-sitter-langs :ensure t)
  #+END_SRC
*** #DISABLED Treesitter (manual install)
Allows the function "treesit-install-language-grammar" to be used to
install and compile one of these languages. Requires a c compiler (cc
or gcc) and c++ compiler (g++).
#+BEGIN_SRC emacs-lisp :tangle no
  (setq treesit-language-source-alist '(
  (rust . ("https://github.com/tree-sitter/tree-sitter-rust" "v0.23.2")) ;v0.23.2 until emacs treesitter support ABI version (https://github.com/rust-lang/rust-mode/issues/568) 
  (python . ("https://github.com/tree-sitter/tree-sitter-python"))
  (javascript . ("https://github.com/tree-sitter/tree-sitter-javascript"))
  (c . ("https://github.com/tree-sitter/tree-sitter-c"))
  (cpp . ("https://github.com/tree-sitter/tree-sitter-cpp"))
  (json . ("https://github.com/tree-sitter/tree-sitter-json"))
  (html . ("https://github.com/tree-sitter/tree-sitter-html"))
  (css . ("https://github.com/tree-sitter/tree-sitter-css"))))
  #+END_SRC
*** LSP (lsp-mode)
#+BEGIN_SRC emacs-lisp
    (use-package lsp-mode
      :ensure t
      :hook
      (dart-mode . lsp-mode)
      (rust-mode . lsp-mode)
      (rustic-mode . lsp-mode)
      :config
      (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]ios(\/|\\\\)(build|Pods|Runner|Share Extension)\\")
      (add-to-list 'lsp-file-watch-ignored-directories "[/\\\\]ios(\/|\\\\)build\\")
      )
#+END_SRC
*** #DISABLED LSP (Built in eglot)
#+BEGIN_SRC emacs-lisp :tangle no
  (use-package eglot
    :hook
    (dart-mode . eglot-ensure)
    (rust-mode . eglot-ensure)
    (rustic-mode . eglot-ensure)
    :bind
    (:map global-map
  	("<leader><leader>a" . eglot-code-actions)
  	("<leader><leader>r" . eglot-rename)
  	))
#+END_SRC
*** Annotations
#+BEGIN_SRC emacs-lisp
  (use-package flycheck
    :ensure t)
#+END_SRC
*** Rust (rustic-mode)
#+BEGIN_SRC emacs-lisp
  (use-package rustic
    :ensure t
    :after rust-mode
    :config
    (setq rustic-format-on-save t)
    )
#+END_SRC
*** Rust (rust-mode)
#+BEGIN_SRC emacs-lisp
  (use-package rust-mode
    :ensure t
    :init
    (setq rust-mode-treesitter-derive t)
    :config
    (add-hook 'rust-mode-hook (lambda () (setq indent-tabs-mode nil)))
    (add-hook 'rust-mode-hook 'electric-pair-mode)
    (add-hook 'rust-mode-hook 'flycheck-mode)
    )
#+END_SRC
*** Flutter/Dart Packages
#+BEGIN_SRC emacs-lisp
  (use-package dart-mode
    :ensure t
    :hook
    (dart-mode . flutter-test-mode)
    (dart-mode . electric-pair-mode))
  (use-package flutter
    :ensure t
    :after dart-mode
    :config 
    (defun my-flutter-run-or-hot-reload ()
      "Start `flutter run` or hot-reload if already running."
      (interactive)
      (if (flutter--running-p)
  	(flutter-hot-reload)
        (flutter-run "-d windows")))
    (defun my-flutter-before-save ()
      (lsp-format-buffer))
    (defun my-flutter-on-save-hot-reload ()
      "Start `flutter run` or hot-reload if already running."
      (lsp-format-buffer)
      (if (flutter--running-p)
  	(flutter-hot-reload)
        nil))
    (add-hook 'flutter-test-mode-hook (lambda () (add-hook 'after-save-hook 'my-flutter-on-save-hot-reload nil 'make-it-local)))
    (add-hook 'flutter-test-mode-hook (lambda () (add-hook 'before-save-hook 'my-flutter-before-save nil 'make-it-local)))
    :bind (:map dart-mode-map
  	      ("C-M-x" . #'my-flutter-run-or-hot-reload)))
  (use-package yaml-mode :ensure t)
#+END_SRC
*** Web dev (templating languages)
#+BEGIN_SRC emacs-lisp
  (use-package web-mode
    :ensure t
    :mode
    (("\\.html" . web-mode))
    :config
    (setq web-mode-engines-alist '(("django" . "\\.html"))))
#+END_SRC

** Auto completion and snippets (Company/Yasnippet)
*** Extra functions to be linked source: [[https://robert.kra.hn/posts/2021-02-07_rust-with-emacs/#:~:text=%20Configuring%20Emacs%20for%20Rust%20development%20%201,order%20to%20setup%20debugging%20support%20for...%20More%20]]
#+BEGIN_SRC emacs-lisp
(defun company-yasnippet-or-completion ()
  (interactive)
  (or (do-yas-expand)
      (company-complete-common)))

(defun check-expansion ()
  (save-excursion
    (if (looking-at "\\_>") t
      (backward-char 1)
      (if (looking-at "\\.") t
        (backward-char 1)
        (if (looking-at "::") t nil)))))

(defun do-yas-expand ()
  (let ((yas/fallback-behavior 'return-nil))
    (yas/expand)))

(defun tab-indent-or-complete ()
  (interactive)
  (if (minibufferp)
      (minibuffer-complete)
    (if (or (not yas/minor-mode)
            (null (do-yas-expand)))
        (if (check-expansion)
            (company-complete-common)
          (indent-for-tab-command)))))
#+END_SRC
*** Company (Completions)
#+BEGIN_SRC emacs-lisp
(use-package company
    :ensure
    :custom
	(company-idle-delay 0.5) ;; how long to wait until popup
	;; (company-begin-commands nil) ;; uncomment to disable popup
    :bind
	(:map company-active-map
		("C-n". company-select-next)
		("C-p". company-select-previous)
		("M-<". company-select-first)
		("M->". company-select-last))
	(:map company-mode-map
		("<tab>". tab-indent-or-complete)
		("TAB". tab-indent-or-complete))
    :config
    (add-hook 'rust-mode-hook 'company-mode))
    (add-hook 'rustic-mode-hook 'company-mode))
#+END_SRC
*** Yasnippet (Snippets)
#+BEGIN_SRC emacs-lisp
(use-package yasnippet
  :ensure t
  :config
  (use-package yasnippet-snippets
    :ensure t)
  (define-key yas-minor-mode-map (kbd "<tab>") nil)
  (define-key yas-minor-mode-map (kbd "C-'") #'yas-expand)
  (add-to-list #'yas-snippet-dirs "~/.emacs.d/snippets")
  (yas-reload-all)
  (add-hook 'prog-mode-hook 'yas-minor-mode)
  (add-hook 'text-mode-hook 'yas-minor-mode)
  (setq yas-prompt-functions '(yas-ido-prompt))
  (defun help/yas-after-exit-snippet-hook-fn ()
    (prettify-symbols-mode)
    (prettify-symbols-mode))
  (add-hook 'yas-after-exit-snippet-hook #'help/yas-after-exit-snippet-hook-fn)
  :diminish yas-minor-mode)
(add-hook 'find-file-hook 'auto-insert)
(use-package yatemplate
  :ensure t
  :config
  (setq templates-private-directory "~/.emacs.d/templates"))
#+END_SRC


** Extra functionality
*** ISpell package (spell checking)
#+BEGIN_SRC emacs-lisp
(use-package ispell
  :ensure t
  :bind
  (("<leader>sw" . 'ispell-word)
   ("<leader>sr" . 'ispell-region)))
#+END_SRC
*** Magit (git in emacs)
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :ensure t
    :bind
    (("<leader> g" . 'magit))
  )
#+END_SRC
*** Mermaid JS Documentation extras (org mode)
#+BEGIN_SRC emacs-lisp
(use-package mermaid-mode
  :ensure t)
#+END_SRC
** Custom Functions
*** Increment or Decrement number at point
#+BEGIN_SRC emacs-lisp
(defun my-increment-number-decimal (&optional arg)
  "Increment the number forward from point by 'arg'."
  (interactive "p*")
  (save-excursion
    (save-match-data
      (let (inc-by field-width answer)
        (setq inc-by (if arg arg 1))
        (skip-chars-backward "0123456789")
        (when (re-search-forward "[0-9]+" nil t)
          (setq field-width (- (match-end 0) (match-beginning 0)))
          (setq answer (+ (string-to-number (match-string 0) 10) inc-by))
          (when (< answer 0)
            (setq answer (+ (expt 10 field-width) answer)))
          (replace-match (format (concat "%0" (int-to-string field-width) "d")
                                 answer)))))))
(defun my-decrement-number-decimal (&optional arg)
  (interactive "p*")
  (my-increment-number-decimal (if arg (- arg) -1)))
(global-set-key (kbd "C-<kp-add>") 'my-increment-number-decimal)
(global-set-key (kbd "C-<kp-subtract>") 'my-decrement-number-decimal)
(define-key function-key-map (kbd "<f13>") 'event-apply-super-modifier)
#+END_SRC
